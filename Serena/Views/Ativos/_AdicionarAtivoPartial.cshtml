@page
@using Serena.Views.Ativos
@model Serena.Views.Ativos._AdicionarAtivoPartialModel

@* Sem @model, pois você ainda não está usando Models *@




@* Partial view sem model fortemente tipado. 
   Campos nomeados para casar com as propriedades do seu Ativo. *@
@* Views/Ativos/_AdicionarAtivoPartial.cshtml *@
@using System.Collections.Generic // Necessário para List<dynamic>


@{
    // Simulação de Dados para o ViewBag (Categorias, Localizações, etc.)
    var categorias = ViewBag.Categorias as IEnumerable<dynamic> ?? new List<dynamic>
    {
        new { Id = 1, Nome = "Equipamento TI" },
        new { Id = 2, Nome = "Mobiliário" },
        new { Id = 3, Nome = "Veículo" }
    };

    var locs = ViewBag.Localizacoes as IEnumerable<dynamic> ?? new List<dynamic>
    {
        new { Id = 1, Nome = "Escritório Central" },
        new { Id = 2, Nome = "Filial Sul" }
    };
    
    // ... (Simule Responsaveis e Usuarios se necessário)
}

<div class="container py-4 bg-light border rounded shadow-sm">
    <h3 class="mb-4 text-primary d-flex align-items-center">
        <i class="bi bi-gear-fill me-2"></i> ⚙️ Cadastro de Ativo
    </h3>

    <form id="formAdicionarAtivo" asp-action="SalvarAtivo" method="post" novalidate>
        @Html.AntiForgeryToken()

        <input type="hidden" id="Id" name="Id" value="" />

        <div class="row g-3">
            
            <div class="col-md-6">
                <label for="Nome" class="form-label d-flex align-items-center">
                    <i class="bi bi-tag-fill me-1"></i> Nome
                </label>
                <input id="Nome" name="Nome" class="form-control" placeholder="Ex: Notebook DELL Latitude" required />
                <div class="text-danger small" data-valmsg-for="Nome" data-valmsg-replace="true"></div>
            </div>

            <div class="col-md-6">
                <label for="CategoriaControl" class="form-label d-flex align-items-center">
                    <i class="bi bi-list-nested me-1"></i> Categoria
                </label>
                
                <div id="CategoriaControl">
                    <div id="selectCategoriaDiv" class="input-group">
                        <select id="CategoriaId" name="CategoriaId" class="form-select">
                            <option value="" selected>-- Selecione a Categoria --</option>
                            @foreach (var c in categorias)
                            {
                                <option value="@c.Id">@c.Nome</option>
                            }
                        </select>
                        <button type="button" 
                                class="btn btn-outline-secondary" 
                                id="btnNovaCategoria" 
                                title="Adicionar nova categoria">
                            ➕ Novo
                        </button>
                    </div>

                    <div id="inputNovaCategoriaDiv" class="input-group mt-2" style="display: none;">
                        <input id="NovaCategoriaNome" name="NovaCategoriaNome" class="form-control" placeholder="Digite o nome da nova categoria" />
                        <button type="button" 
                                class="btn btn-outline-danger" 
                                id="btnCancelarNovaCategoria" 
                                title="Cancelar">
                            ❌
                        </button>
                    </div>
                </div>
                <div class="text-danger small" data-valmsg-for="CategoriaId" data-valmsg-replace="true"></div>
                <div class="text-danger small" data-valmsg-for="NovaCategoriaNome" data-valmsg-replace="true"></div>
            </div>
            
            <div class="col-md-6">
                <label for="NumeroDeSerie" class="form-label d-flex align-items-center">
                    <i class="bi bi-qr-code me-1"></i> Número de Série / Patrimônio
                </label>
                <input id="NumeroDeSerie" name="NumeroDeSerie" class="form-control" placeholder="Opcional" />
            </div>

            <div class="col-md-6">
                <label for="DataAquisicao" class="form-label d-flex align-items-center">
                    <i class="bi bi-calendar-check me-1"></i> Data de Aquisição
                </label>
                <input id="DataAquisicao" name="DataAquisicao" type="date" class="form-control" required />
            </div>

            <div class="col-md-4">
                <label for="LocalizacaoId" class="form-label d-flex align-items-center">
                    <i class="bi bi-geo-alt-fill me-1"></i> Localização
                </label>
                <select id="LocalizacaoId" name="LocalizacaoId" class="form-select">
                    <option value="" selected>-- (nenhuma) --</option>
                    @foreach (var l in locs)
                    {
                        <option value="@l.Id">@l.Nome</option>
                    }
                </select>
            </div>
            
            <div class="col-md-4">
                <label for="ResponsavelId" class="form-label d-flex align-items-center">
                    <i class="bi bi-person-badge-fill me-1"></i> Responsável
                </label>
                <select id="ResponsavelId" name="ResponsavelId" class="form-select">
                    <option value="" selected>-- (nenhum) --</option>
                    @* Renderizar Responsaveis *@
                </select>
            </div>

            <div class="col-md-4">
                <label for="Estado" class="form-label d-flex align-items-center">
                    <i class="bi bi-activity me-1"></i> Estado
                </label>
                <select id="Estado" name="Estado" class="form-select">
                    <option value="Disponivel" selected>Disponível</option>
                    <option value="EmUso">Em Uso</option>
                    <option value="EmManutencao">Em Manutenção</option>
                    <option value="Baixado">Baixado</option>
                </select>
            </div>

            <div class="col-12">
                <label for="Observacoes" class="form-label d-flex align-items-center">
                    <i class="bi bi-chat-left-text-fill me-1"></i> Observações
                </label>
                <textarea id="Observacoes" name="Observacoes" class="form-control" rows="3" placeholder="Informações adicionais sobre o ativo."></textarea>
            </div>
        </div>

        <hr class="my-4" />

        <div class="d-flex gap-2 justify-content-end">
            <button type="submit" class="btn btn-success btn-lg d-flex align-items-center">
                <i class="bi bi-save-fill me-2"></i> Salvar Ativo
            </button>
            <a href="@Url.Action("CarregarAtivos", "Ativos")" 
               id="link-para-consulta" 
               class="btn btn-secondary btn-lg d-flex align-items-center">
                <i class="bi bi-x-circle-fill me-2"></i> Cancelar
            </a>
        </div>
    </form>
</div>

<script>
    // Esta função deve ser chamada dentro de setupPartialEvents() no validador.js
    // para garantir que os eventos sejam reatribuídos após o carregamento AJAX.
    function setupAdicionarAtivoEvents() {
        const selectDiv = document.getElementById('selectCategoriaDiv');
        const inputDiv = document.getElementById('inputNovaCategoriaDiv');
        const selectCategoria = document.getElementById('CategoriaId');
        const inputNovaCategoria = document.getElementById('NovaCategoriaNome');
        const btnNovaCategoria = document.getElementById('btnNovaCategoria');
        const btnCancelar = document.getElementById('btnCancelarNovaCategoria');

        if (!btnNovaCategoria) return; // Sai se a view não carregou corretamente

        // 1. Mostrar o campo de nova categoria
        btnNovaCategoria.addEventListener('click', function () {
            selectDiv.style.display = 'none';
            inputDiv.style.display = 'flex'; // Exibe o input
            selectCategoria.value = ''; // Limpa a seleção
            selectCategoria.name = ''; // Remove o name para não ser enviado no form
            inputNovaCategoria.name = 'NovaCategoriaNome'; // Adiciona o name para ser enviado
            inputNovaCategoria.focus();
        });

        // 2. Voltar para a seleção
        btnCancelar.addEventListener('click', function () {
            selectDiv.style.display = 'flex'; // Exibe o select
            inputDiv.style.display = 'none';
            inputNovaCategoria.value = ''; // Limpa o input
            inputNovaCategoria.name = ''; // Remove o name
            selectCategoria.name = 'CategoriaId'; // Restaura o name
        });
        
        // --- Lógica de Validação (Obrigatório selecionar OU digitar) ---
        // Você precisará de lógica AJAX/Controller para tratar se CategoriaId OU NovaCategoriaNome vier preenchido.
    }
    
    // Se esta view for carregada via AJAX, chame a função
    setupAdicionarAtivoEvents();

</script>
@* Validações client-side (jQuery Validate) se estiver usando unobtrusive validation *@


